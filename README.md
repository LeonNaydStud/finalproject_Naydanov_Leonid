# ValutaTrade Hub - Валютный кошелек

## Описание проекта

**ValutaTrade Hub** - это комплексная платформа для управления виртуальным портфелем фиатных и криптовалют. Приложение позволяет пользователям регистрироваться, отслеживать актуальные курсы валют в реальном времени, совершать сделки по покупке и продаже, а также анализировать состояние своего портфеля.

### Основные возможности:
- Отслеживание курсов крипто- и фиатных валют
- Регистрация и аутентификация пользователей
- Управление мультивалютным портфелем
- Совершение сделок купли/продажи валют
- Расчет общей стоимости портфеля
- Автоматическое обновление курсов по расписанию
- Детальное логирование всех операций

### Используемые технологии:
- **Python 3.9+** - основной язык программирования
- **Poetry** - управление зависимостями
- **PrettyTable** - форматированный вывод в консоли
- **Requests** - HTTP запросы к внешним API
- **Ruff** - линтер и форматтер кода

## Структура каталогов

```
valuta_trade_hub/
├── data/                           # Хранение данных
│   ├── users.json                  # Данные пользователей
│   ├── portfolios.json             # Портфели пользователей
│   ├── rates.json                  # Кэш курсов валют
│   └── exchange_rates.json         # История курсов
├── logs/                           # Логи приложения
├── valutatrade_hub/                # Исходный код
│   ├── core/                       # Бизнес-логика
│   │   ├── currencies.py           # Классы валют
│   │   ├── exceptions.py           # Пользовательские исключения
│   │   ├── models.py               # Модели данных
│   │   ├── usecases.py             # Бизнес-кейсы
│   │   └── utils.py                # Вспомогательные функции
│   ├── infra/                      # Инфраструктура
│   │   ├── settings.py             # Настройки (Singleton)
│   │   └── database.py             # Работа с JSON БД
│   ├── parser_service/             # Сервис парсинга
│   │   ├── config.py               # Конфигурация API
│   │   ├── api_clients.py          # Клиенты API
│   │   ├── updater.py              # Обновление курсов
│   │   ├── storage.py              # Хранение истории
│   │   └── scheduler.py            # Планировщик
│   ├── cli/                        # Командный интерфейс
│   │   └── interface.py            # CLI команды
│   ├── logging_config.py           # Конфигурация логов
│   └── decorators.py               # Декораторы для логирования
├── main.py                         # Точка входа
├── Makefile                        # Автоматизация команд
├── pyproject.toml                  # Зависимости и конфигурация
├── poetry.lock                     # Фиксация версий
├── README.md                       # Документация
└── .gitignore                      # Исключения Git
```

## Установка

### Предварительные требования

- Python 3.9 или выше
- Poetry (менеджер зависимостей)
- API ключ от ExchangeRate-API (бесплатный)

### Установка Poetry (если не установлен)

```bash
# Linux/Mac
curl -sSL https://install.python-poetry.org | python3 -

# Windows (PowerShell)
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
```

### Установка зависимостей проекта

```bash
# Клонируйте репозиторий
git clone <repository-url>
cd finalproject_<фамилия>_<группа>

# Установите зависимости через Makefile
make install

# Или напрямую через Poetry
poetry install
```

## Настройка API ключей

### Получение ключа ExchangeRate-API

1. Зарегистрируйтесь на https://www.exchangerate-api.com/
2. Получите бесплатный API ключ (например: `3b47a9b92e1b14c1f1234567`)
3. Сохраните ключ через pyproject.toml:

Добавьте в секцию `[tool.valutatrade]` в `pyproject.toml`:

```toml
[tool.valutatrade]
exchangerate_api_key = "ваш_ключ_здесь"
```

## Запуск приложения

### Интерактивный режим (рекомендуется)

```bash
# Через Makefile
make project

# Или напрямую через Poetry
poetry run project
```

### Одноразовые команды

```bash
# Выполнение конкретной команды
poetry run project register --username alice --password 1234
poetry run project login --username alice --password 1234
```

## Примеры команд CLI

### Регистрация и аутентификация

```
register alice 1234           # Регистрация нового пользователя
login alice 1234              # Вход в систему
logout                        # Выход из системы
```

### Управление портфелем

```
portfolio                     # Показать портфель (база: USD)
portfolio --base EUR          # Показать портфель в евро
buy BTC 0.01                  # Купить 0.01 Bitcoin
sell BTC 0.005                # Продать 0.005 Bitcoin
```

### Работа с курсами валют

```
update_rates                  # Обновить все курсы валют
update_rates coingecko        # Обновить только криптовалюты
update_rates exchangerate     # Обновить только фиатные валюты
show_rates                    # Показать все курсы
show_rates --top 5            # Показать топ-5 курсов
show_rates --currency BTC     # Показать курс Bitcoin
get_rate USD BTC              # Получить курс USD к BTC
get_rate EUR USD              # Получить курс EUR к USD
```

### Системные команды

```
help                          # Показать справку по всем командам
help <команда>                # Подробная справка по команде
exit                          # Выход из программы
```

## Кэширование и TTL курсов

### Механизм кэширования

Приложение использует двухуровневое кэширование курсов:

1. **rates.json** - основной кэш последних курсов
2. **exchange_rates.json** - история всех курсов

### Настройка TTL (Time To Live)

По умолчанию кэш курсов считается актуальным в течение **5 минут (300 секунд)**. Это настраивается в `pyproject.toml`:

```toml
[tool.valutatrade]
rates_ttl_seconds = 300  # 5 минут
```

### Поведение при истечении TTL

1. При запросе курса проверяется время последнего обновления
2. Если данные старше `rates_ttl_seconds`, система:
   - Автоматически пытается обновить курсы через Parser Service
   - Если обновление не удалось, использует устаревшие данные с предупреждением
   - Логирует попытку обновления

### Ручное управление кэшем

```bash
# Принудительное обновление кэша
update_rates

# Просмотр статуса кэша
# (информация о времени последнего обновления показывается в командах)
show_rates
```

## Parser Service

### Описание

Parser Service - это отдельный микросервис, который отвечает за сбор актуальных курсов валют из внешних источников:

1. **CoinGecko API** - для криптовалют (BTC, ETH, SOL и др.)
2. **ExchangeRate-API** - для фиатных валют (USD, EUR, GBP и др.)

### Включение автоматического обновления

Для включения автоматического обновления курсов по расписанию:

```python
# Включите в своем коде:
from valutatrade_hub.parser_service.scheduler import RatesScheduler

scheduler = RatesScheduler(update_interval_minutes=15)  # Каждые 15 минут
scheduler.start(background=True)
```

### Настройка расписания

Интервал обновления настраивается в конструкторе `RatesScheduler`:

```python
# Обновление каждые 30 минут
scheduler = RatesScheduler(update_interval_minutes=30)

# Обновление каждый час
scheduler = RatesScheduler(update_interval_minutes=60)
```

### Ручной запуск парсера

```bash
# Обновить все курсы
poetry run project update_rates

# Обновить только криптовалюты
poetry run project update_rates coingecko

# Обновить только фиатные валюты
poetry run project update_rates exchangerate
```

## Логирование

### Настройка логов

Логирование настраивается в `valutatrade_hub/logging_config.py`:

```python
# Уровни логирования:
# DEBUG - детальная информация для отладки
# INFO - информационные сообщения (по умолчанию)
# WARNING - предупреждения
# ERROR - ошибки
# CRITICAL - критические ошибки
```

### Расположение логов

Логи сохраняются в `logs/actions.log` с ротацией:
- Максимальный размер файла: 5 МБ
- Хранится до 3 резервных копий
- Кодировка: UTF-8

### Просмотр логов

```bash
# Последние 20 строк лога
tail -20 logs/actions.log

# Просмотр в реальном времени
tail -f logs/actions.log

# Поиск ошибок
grep "ERROR" logs/actions.log
```

## Разработка и тестирование

### Запуск тестов

```bash
# Проверка качества кода
make lint

# Автоматическое исправление ошибок
poetry run ruff check . --fix

# Форматирование кода
poetry run ruff format .
```

### Сборка пакета

```bash
# Сборка проекта
make build

# Тестовая публикация
make publish

# Установка локально
make package-install
```

### Структура тестирования

Для полного тестирования функционала выполните следующие команды:

1. Регистрация и вход пользователей
2. Обновление курсов валют
3. Покупка и продажа валют
4. Проверка портфеля в разных валютах
5. Тестирование обработки ошибок

### Контакты

- Автор: Найданов Леонид
